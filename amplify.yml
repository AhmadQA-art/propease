version: 1
frontend:
  phases:
    preBuild:
      commands:
        - "nvm install 20"
        - "nvm use 20"
        - "cd frontend"
        - "rm -rf node_modules package-lock.json"
        - "npm cache clean --force"
        - "npm install --legacy-peer-deps"
        - "npm install --save-dev vite@5.4.18 @vitejs/plugin-react@4.3.4"
        - "echo 'module.exports = {plugins: {}};' > postcss.config.cjs"
    
    build:
      commands:
        - "cd frontend"
        - "export NODE_ENV=production"
        - "export VITE_API_URL=https://propease-backend-2-env.eba-mgfe8nm9.us-east-2.elasticbeanstalk.com"
        - "echo 'VITE_API_URL=$VITE_API_URL' > .env.production.local"
        - "echo 'import { defineConfig } from \"vite\";' > vite.config.js"
        - "echo 'import react from \"@vitejs/plugin-react\";' >> vite.config.js"
        - "echo 'import path from \"path\";' >> vite.config.js"
        - "echo 'import { fileURLToPath } from \"url\";' >> vite.config.js"
        - "echo '' >> vite.config.js"
        - "echo 'const __dirname = path.dirname(fileURLToPath(import.meta.url));' >> vite.config.js"
        - "echo '' >> vite.config.js"
        - "echo 'export default defineConfig({' >> vite.config.js"
        - "echo '  plugins: [react()],' >> vite.config.js"
        - "echo '  resolve: {' >> vite.config.js"
        - "echo '    alias: {' >> vite.config.js"
        - "echo '      \"@\": path.resolve(__dirname, \"./src\"),' >> vite.config.js"
        - "echo '    },' >> vite.config.js"
        - "echo '  },' >> vite.config.js"
        - "echo '  build: {' >> vite.config.js"
        - "echo '    outDir: \"build\",' >> vite.config.js"
        - "echo '  },' >> vite.config.js"
        - "echo '});' >> vite.config.js"
        - "rm -rf dist build"
        - "npx vite build --mode production"

  artifacts:
    baseDirectory: frontend/build
    files:
      - "**/*"
  
  cache:
    paths:
      - "node_modules/**/*"
      - "frontend/node_modules/**/*"