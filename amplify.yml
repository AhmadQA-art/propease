version: 1
frontend:
  phases:
    preBuild:
      commands:
        - "nvm install 20"
        - "nvm use 20"
        - "rm -rf node_modules"
        - "npm ci"
        - "mkdir -p frontend"
        - "echo 'module.exports = { plugins: {} };' > frontend/postcss.config.cjs"
        - "cd frontend"
    
    build:
      commands:
        - "export NODE_ENV=production"
        - "export VITE_API_URL=https://propease-backend-2-env.eba-mgfe8nm9.us-east-2.elasticbeanstalk.com"
        - "echo \"VITE_API_URL=$VITE_API_URL\" > .env.production.local"
        - |
          # Create vite.config.js file with explicit root path
          cat > vite.config.js << 'EOL'
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';
          import path from 'path';
          import { fileURLToPath } from 'url';

          const __dirname = path.dirname(fileURLToPath(import.meta.url));

          export default defineConfig({
            plugins: [react()],
            root: __dirname, // Set the root to frontend directory
            resolve: {
              alias: {
                '@': path.resolve(__dirname, './src'),
              },
            },
            build: {
              outDir: 'build',
            },
          });
          EOL
        - "rm -rf dist build || true"
        - |
          # Build using workspace-aware command
          echo "Building frontend with workspace command..."
          
          # Execute the build command directly
          # Try npm run build first, then fallback to direct vite calls
          echo "Current directory before build: $(pwd)"
          echo "Trying to build with npm run build..."
          npm run build || ../node_modules/.bin/vite build --mode production || npx vite build --mode production
          
          # Verify build output exists
          if [ -d "build" ]; then
            echo "Build successful! Output found in $(pwd)/build"
            ls -la build
          else
            echo "ERROR: Build directory not found at $(pwd)/build"
            ls -la
            exit 1
          fi

  artifacts:
    baseDirectory: frontend/build
    files:
      - "**/*"

  cache:
    paths:
      - node_modules/**/*