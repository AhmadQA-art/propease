version: 1
appRoot: frontend
frontend:
  phases:
    preBuild:
      commands:
        - "nvm install 20"
        - "nvm use 20"
        - "rm -rf node_modules"
        - "npm ci"
        - "mkdir -p frontend"
        - "echo 'module.exports = { plugins: {} };' > frontend/postcss.config.cjs"
    
    build:
      commands:
        - "export NODE_ENV=production"
        - "export VITE_API_URL=https://propease-backend-2-env.eba-mgfe8nm9.us-east-2.elasticbeanstalk.com"
        - "mkdir -p frontend"
        - "echo \"VITE_API_URL=$VITE_API_URL\" > frontend/.env.production.local"
        - |
          # Create vite.config.js file with explicit root path
          mkdir -p frontend
          cat > frontend/vite.config.js << 'EOL'
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';
          import path from 'path';
          import { fileURLToPath } from 'url';

          const __dirname = path.dirname(fileURLToPath(import.meta.url));

          export default defineConfig({
            plugins: [react()],
            root: __dirname, // Set the root to frontend directory
            resolve: {
              alias: {
                '@': path.resolve(__dirname, './src'),
              },
            },
            build: {
              outDir: 'build',
            },
          });
          EOL
        - "mkdir -p frontend"
        - "rm -rf frontend/dist frontend/build || true"
        - |
          # Build using workspace-aware command with explicit root
          echo "Building frontend with workspace command..."
          if [ ! -d "frontend" ]; then
            echo "Creating frontend directory..."
            mkdir -p frontend
          fi
          cd frontend && ../node_modules/.bin/vite build --mode production
        - "ls -la frontend/build || echo \"WARNING: frontend/build directory does not exist!\""
        - "pwd && ls -la frontend || echo \"Listing frontend directory contents for debugging\""

  artifacts:
    baseDirectory: frontend/build
    files:
      - "**/*"

  cache:
    paths:
      - node_modules/**/*