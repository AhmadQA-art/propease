version: 1
appRoot: frontend
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 20
        - nvm use 20
        - rm -rf node_modules
        - npm ci
        - |
          cat > postcss.config.cjs << 'EOF'
          module.exports = { plugins: {} };
          EOF
    
    build:
      commands:
        - export NODE_ENV=production
        - export VITE_API_URL=https://propease-backend-2-env.eba-mgfe8nm9.us-east-2.elasticbeanstalk.com
        - |
          cat > .env.production.local << 'EOF'
          VITE_API_URL=$VITE_API_URL
          EOF
        - |
          cat > vite.config.js << 'EOF'
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';
          import path from 'path';
          import { fileURLToPath } from 'url';

          const __dirname = path.dirname(fileURLToPath(import.meta.url));

          export default defineConfig({
            plugins: [react()],
            root: __dirname,
            resolve: {
              alias: {
                '@': path.resolve(__dirname, './src'),
              },
            },
            build: {
              outDir: 'build',
            },
          });
          EOF
        - rm -rf dist build
        - node_modules/.bin/vite build --mode production
        - ls -la build || echo "WARNING: build directory does not exist!"
        - pwd && ls -la . || echo "Listing directory contents for debugging"

  artifacts:
    baseDirectory: build
    files:
      - '**/*'

  cache:
    paths:
      - node_modules/**/*