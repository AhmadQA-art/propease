version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 20
        - nvm use 20
        - ls -l
        - 'if [ -d "frontend" ]; then echo "frontend/ exists"; else echo "frontend/ missing"; exit 1; fi'
        - rm -rf node_modules package-lock.json
        - npm cache clean --force
        - npm install --legacy-peer-deps
        - 'npm list vite || echo "Vite not listed in root dependencies"'
        - npm install --workspaces --legacy-peer-deps --include=optional
        - npm install --save-dev esbuild@0.21.5 @esbuild/linux-x64@0.21.5 @rollup/rollup-linux-x64-gnu client-only @tanstack/react-virtual --legacy-peer-deps
        - cd frontend
        - 'if [ -f "vite.config.ts" ]; then cp vite.config.ts vite.config.ts.bak; fi'
        - 'if [ -f "vite.config.js" ]; then cp vite.config.js vite.config.js.bak; fi'
        - |
          cat > vite.config.ts << 'EOF'
          import { defineConfig } from 'vite'
          import react from '@vitejs/plugin-react'

          export default defineConfig({
            plugins: [react()],
            build: {
              rollupOptions: {
                external: ['client-only', '@tanstack/react-virtual']
              }
            }
          })
          EOF
        - rm -rf node_modules package-lock.json
        - npm cache clean --force
        # Install TypeScript to support .ts config files
        - npm install --save-dev typescript
        # Install Vite and React plugin locally (remove global install)
        - npm install --save-dev vite@5.4.18 @vitejs/plugin-react@4.3.4
        - npm install --no-optional --legacy-peer-deps
        - echo "Checking for Vite availability..."
        - |
          echo "console.log('Vite test');" > vite-test.js
          if ./node_modules/.bin/vite --version >/dev/null 2>&1; then
            echo "Vite is available locally"
          else
            echo "ERROR: Vite command not found locally"
            npm list vite
            exit 1
          fi
        - cd ..
    build:
      commands:
        - echo "Building frontend application..."
        - export NODE_ENV=production
        - export VITE_API_URL=https://propease-backend-2-env.eba-mgfe8nm9.us-east-2.elasticbeanstalk.com
        - mkdir -p frontend
        - 'echo "VITE_API_URL=$VITE_API_URL" > frontend/.env.production.local'
        - cd frontend
        - rm -rf dist
        # Use the local Vite binary directly
        - ./node_modules/.bin/vite build --mode production || { echo "Build failed"; exit 1; }
        - cd ..
  artifacts:
    baseDirectory: frontend/dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - frontend/node_modules/**/*